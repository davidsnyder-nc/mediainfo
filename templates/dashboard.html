<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Tracker Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected {
            background-color: #198754;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
        .card {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e9ecef;
            border-radius: 12px 12px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        .media-card {
            transition: transform 0.2s ease;
        }
        .media-card:hover {
            transform: translateY(-2px);
        }
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .last-updated {
            font-size: 0.85rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="/">
                <i class="bi bi-collection-play me-2"></i>Media Tracker Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a href="/" class="nav-link">
                    <i class="bi bi-gear me-1"></i>Configuration
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        
        <!-- Dashboard Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Dashboard Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label for="daysRange" class="form-label">Time Range</label>
                                <select class="form-select" id="daysRange">
                                    <option value="1">Last 1 day</option>
                                    <option value="3">Last 3 days</option>
                                    <option value="7" selected>Last 7 days</option>
                                    <option value="14">Last 14 days</option>
                                    <option value="30">Last 30 days</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Show Sections</label>
                                <div class="d-flex flex-wrap gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showStatus" checked>
                                        <label class="form-check-label" for="showStatus">System Status</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showMovies" checked>
                                        <label class="form-check-label" for="showMovies">Movies</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showTVShows" checked>
                                        <label class="form-check-label" for="showTVShows">TV Shows</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showSchedule" checked>
                                        <label class="form-check-label" for="showSchedule">TV Schedule</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showLibraryStats">
                                        <label class="form-check-label" for="showLibraryStats">Library Stats</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Display Options</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showExtendedInfo">
                                    <label class="form-check-label" for="showExtendedInfo">Show Extended Info</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoRefresh">
                                    <label class="form-check-label" for="autoRefresh">Auto Refresh (5min)</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-primary" onclick="refreshDashboard()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Apply Settings & Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Section -->
        <div class="row mb-4" id="statusRow">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-activity me-2"></i>System Status</h5>
                        <span class="last-updated" id="statusLastUpdated">Loading...</span>
                    </div>
                    <div class="card-body" id="statusSection">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading system status...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Movies -->
        <div class="row mb-4" id="moviesRow">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-film me-2"></i>Recently Added Movies</h5>
                        <span class="last-updated" id="moviesLastUpdated">Loading...</span>
                    </div>
                    <div class="card-body" id="moviesSection">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading recent movies...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent TV Shows -->
        <div class="row mb-4" id="tvShowsRow">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-tv me-2"></i>Recently Added TV Shows</h5>
                        <span class="last-updated" id="tvLastUpdated">Loading...</span>
                    </div>
                    <div class="card-body" id="tvShowsSection">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading recent TV shows...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TV Schedule -->
        <div class="row mb-4" id="scheduleRow">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>TV Schedule</h5>
                        <span class="last-updated" id="scheduleLastUpdated">Loading...</span>
                    </div>
                    <div class="card-body" id="scheduleSection">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading TV schedule...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Statistics -->
        <div class="row mb-4" id="libraryStatsRow" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Library Statistics</h5>
                        <span class="last-updated" id="libraryStatsLastUpdated">Loading...</span>
                    </div>
                    <div class="card-body" id="libraryStatsSection">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading library statistics...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn btn-primary refresh-btn rounded-circle" onclick="refreshData()" title="Refresh Data">
        <i class="bi bi-arrow-clockwise"></i>
    </button>

    <script>
        let refreshing = false;

        function formatTimestamp() {
            return new Date().toLocaleString();
        }

        function loadStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const statusHtml = `
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <span class="status-indicator status-${data.plex.connected ? 'connected' : 'disconnected'}"></span>
                                    <div>
                                        <div class="fw-bold">Plex</div>
                                        <small class="text-muted">${data.plex.connected ? 'Connected' : 'Disconnected'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <span class="status-indicator status-${data.sonarr.connected ? 'connected' : 'disconnected'}"></span>
                                    <div>
                                        <div class="fw-bold">Sonarr</div>
                                        <small class="text-muted">${data.sonarr.connected ? 'Connected' : 'Disconnected'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <span class="status-indicator status-${data.github.connected ? 'connected' : 'disconnected'}"></span>
                                    <div>
                                        <div class="fw-bold">GitHub</div>
                                        <small class="text-muted">${data.github.connected ? 'Connected' : 'Disconnected'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <i class="bi bi-clock me-2 text-primary"></i>
                                    <div>
                                        <div class="fw-bold">Scheduler</div>
                                        <small class="text-muted">${data.scheduler.enabled ? 'Enabled' : 'Disabled'}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('statusSection').innerHTML = statusHtml;
                    document.getElementById('statusLastUpdated').textContent = `Updated: ${formatTimestamp()}`;
                })
                .catch(error => {
                    document.getElementById('statusSection').innerHTML = '<div class="alert alert-danger">Error loading status information</div>';
                    document.getElementById('statusLastUpdated').textContent = `Error: ${formatTimestamp()}`;
                });
        }

        function getDaysRange() {
            return document.getElementById('daysRange').value;
        }

        function getShowExtendedInfo() {
            return document.getElementById('showExtendedInfo').checked;
        }

        function loadRecentContent() {
            const days = getDaysRange();
            fetch(`/api/full_sync?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Display movies
                        if (data.data.movies && data.data.movies.length > 0) {
                            const moviesHtml = data.data.movies.map(movie => `
                                <div class="col-lg-4 col-md-6 mb-3">
                                    <div class="card media-card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">${movie.title} <span class="text-muted">(${movie.year})</span></h6>
                                            <p class="card-text text-muted small">${movie.summary ? movie.summary.substring(0, 120) + '...' : 'No summary available'}</p>
                                            <div class="row small">
                                                <div class="col-6">
                                                    <strong>Added:</strong> ${movie.added_date}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Duration:</strong> ${movie.duration_formatted || 'Unknown'}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Rating:</strong> ${movie.rating || 'N/A'}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Studio:</strong> ${movie.studio || 'Unknown'}
                                                </div>
                                            </div>
                                            ${movie.genres && movie.genres.length > 0 ? `
                                                <div class="mt-2">
                                                    ${movie.genres.slice(0, 3).map(genre => `<span class="badge bg-secondary me-1">${genre}</span>`).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                            document.getElementById('moviesSection').innerHTML = '<div class="row">' + moviesHtml + '</div>';
                        } else {
                            document.getElementById('moviesSection').innerHTML = '<div class="text-center text-muted"><i class="bi bi-film display-1"></i><p class="mt-2">No movies added today</p></div>';
                        }

                        // Display TV shows
                        if (data.data.tv_shows && data.data.tv_shows.length > 0) {
                            const tvHtml = data.data.tv_shows.map(show => `
                                <div class="col-lg-4 col-md-6 mb-3">
                                    <div class="card media-card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">${show.title}</h6>
                                            <p class="card-text text-muted small">${show.summary ? show.summary.substring(0, 120) + '...' : 'No summary available'}</p>
                                            <div class="row small">
                                                <div class="col-6">
                                                    <strong>Added:</strong> ${show.added_date}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Seasons:</strong> ${show.season_count || '0'}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Episodes:</strong> ${show.episode_count || '0'}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Rating:</strong> ${show.rating || 'N/A'}
                                                </div>
                                            </div>
                                            ${show.genres && show.genres.length > 0 ? `
                                                <div class="mt-2">
                                                    ${show.genres.slice(0, 3).map(genre => `<span class="badge bg-secondary me-1">${genre}</span>`).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                            document.getElementById('tvShowsSection').innerHTML = '<div class="row">' + tvHtml + '</div>';
                        } else {
                            document.getElementById('tvShowsSection').innerHTML = '<div class="text-center text-muted"><i class="bi bi-tv display-1"></i><p class="mt-2">No TV shows added today</p></div>';
                        }

                        // Display schedule
                        if (data.data.scheduled_shows && data.data.scheduled_shows.length > 0) {
                            const scheduleHtml = data.data.scheduled_shows.map(show => `
                                <div class="col-lg-6 mb-3">
                                    <div class="card media-card">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">${show.series_title}</h6>
                                            <p class="mb-1">Season ${show.season}, Episode ${show.episode}: <span class="fw-semibold">${show.episode_title}</span></p>
                                            <small class="text-muted"><i class="bi bi-clock me-1"></i>Airs: ${show.air_date}</small>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                            document.getElementById('scheduleSection').innerHTML = '<div class="row">' + scheduleHtml + '</div>';
                        } else {
                            document.getElementById('scheduleSection').innerHTML = '<div class="text-center text-muted"><i class="bi bi-calendar-event display-1"></i><p class="mt-2">No shows scheduled for today</p></div>';
                        }

                        const timestamp = formatTimestamp();
                        document.getElementById('moviesLastUpdated').textContent = `Updated: ${timestamp}`;
                        document.getElementById('tvLastUpdated').textContent = `Updated: ${timestamp}`;
                        document.getElementById('scheduleLastUpdated').textContent = `Updated: ${timestamp}`;
                    }
                })
                .catch(error => {
                    document.getElementById('moviesSection').innerHTML = '<div class="alert alert-danger">Error loading movie data</div>';
                    document.getElementById('tvShowsSection').innerHTML = '<div class="alert alert-danger">Error loading TV show data</div>';
                    document.getElementById('scheduleSection').innerHTML = '<div class="alert alert-danger">Error loading schedule data</div>';
                    
                    const timestamp = formatTimestamp();
                    document.getElementById('moviesLastUpdated').textContent = `Error: ${timestamp}`;
                    document.getElementById('tvLastUpdated').textContent = `Error: ${timestamp}`;
                    document.getElementById('scheduleLastUpdated').textContent = `Error: ${timestamp}`;
                });
        }

        function refreshData() {
            if (refreshing) return;
            
            refreshing = true;
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.classList.add('spin');
            
            loadStatus();
            loadRecentContent();
            
            setTimeout(() => {
                refreshing = false;
                refreshBtn.classList.remove('spin');
            }, 1000);
        }

        function refreshDashboard() {
            console.log('Refreshing dashboard with new settings...');
            
            // Visual feedback
            const btn = document.querySelector('button[onclick="refreshDashboard()"]');
            let originalText = '';
            if (btn) {
                originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spin"></i>Refreshing...';
                btn.disabled = true;
            }
            
            // Function to restore button state
            const restoreButton = () => {
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            };
            
            // Update sections immediately
            updateSectionVisibility();
            
            // Load data with error handling
            Promise.allSettled([
                loadStatusPromise(),
                loadRecentContentPromise(),
                loadLibraryStatsPromise()
            ]).finally(() => {
                setupAutoRefresh();
                restoreButton();
            });
        }
        
        function loadStatusPromise() {
            return fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const statusHtml = `
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <span class="status-indicator status-${data.plex.connected ? 'connected' : 'disconnected'}"></span>
                                    <div>
                                        <div class="fw-bold">Plex</div>
                                        <small class="text-muted">${data.plex.connected ? 'Connected' : 'Disconnected'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <span class="status-indicator status-${data.sonarr.connected ? 'connected' : 'disconnected'}"></span>
                                    <div>
                                        <div class="fw-bold">Sonarr</div>
                                        <small class="text-muted">${data.sonarr.connected ? 'Connected' : 'Disconnected'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <span class="status-indicator status-${data.github.connected ? 'connected' : 'disconnected'}"></span>
                                    <div>
                                        <div class="fw-bold">GitHub</div>
                                        <small class="text-muted">${data.github.connected ? 'Connected' : 'Disconnected'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <i class="bi bi-clock me-2 text-primary"></i>
                                    <div>
                                        <div class="fw-bold">Scheduler</div>
                                        <small class="text-muted">${data.scheduler.enabled ? 'Enabled' : 'Disabled'}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('statusSection').innerHTML = statusHtml;
                    document.getElementById('statusLastUpdated').textContent = `Updated: ${formatTimestamp()}`;
                })
                .catch(error => {
                    document.getElementById('statusSection').innerHTML = '<div class="alert alert-danger">Error loading status information</div>';
                    document.getElementById('statusLastUpdated').textContent = `Error: ${formatTimestamp()}`;
                });
        }
        
        function loadRecentContentPromise() {
            const days = getDaysRange();
            return fetch(`/api/full_sync?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Display movies
                        if (data.data.movies && data.data.movies.length > 0) {
                            const moviesHtml = data.data.movies.map(movie => `
                                <div class="col-lg-4 col-md-6 mb-3">
                                    <div class="card media-card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">${movie.title} <span class="text-muted">(${movie.year})</span></h6>
                                            <p class="card-text text-muted small">${movie.summary ? movie.summary.substring(0, 120) + '...' : 'No summary available'}</p>
                                            <div class="row small">
                                                <div class="col-6">
                                                    <strong>Added:</strong> ${movie.added_date}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Rating:</strong> ${movie.rating || 'N/A'}
                                                </div>
                                            </div>
                                            ${movie.genres && movie.genres.length > 0 ? `
                                                <div class="mt-2">
                                                    ${movie.genres.slice(0, 3).map(genre => `<span class="badge bg-secondary me-1">${genre}</span>`).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                            document.getElementById('moviesSection').innerHTML = '<div class="row">' + moviesHtml + '</div>';
                        } else {
                            document.getElementById('moviesSection').innerHTML = '<div class="text-center text-muted"><i class="bi bi-film display-1"></i><p class="mt-2">No movies found for the selected time period</p></div>';
                        }

                        // Display TV shows
                        if (data.data.tv_shows && data.data.tv_shows.length > 0) {
                            const tvHtml = data.data.tv_shows.map(show => `
                                <div class="col-lg-4 col-md-6 mb-3">
                                    <div class="card media-card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">${show.title} <span class="text-muted">(${show.year})</span></h6>
                                            <p class="card-text text-muted small">${show.summary ? show.summary.substring(0, 120) + '...' : 'No summary available'}</p>
                                            <div class="row small">
                                                <div class="col-6">
                                                    <strong>Added:</strong> ${show.added_date}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Episodes:</strong> ${show.episode_count || 'Unknown'}
                                                </div>
                                            </div>
                                            ${show.genres && show.genres.length > 0 ? `
                                                <div class="mt-2">
                                                    ${show.genres.slice(0, 3).map(genre => `<span class="badge bg-secondary me-1">${genre}</span>`).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                            document.getElementById('tvShowsSection').innerHTML = '<div class="row">' + tvHtml + '</div>';
                        } else {
                            document.getElementById('tvShowsSection').innerHTML = '<div class="text-center text-muted"><i class="bi bi-tv display-1"></i><p class="mt-2">No TV shows found for the selected time period</p></div>';
                        }

                        // Display schedule
                        if (data.data.scheduled_shows && data.data.scheduled_shows.length > 0) {
                            const scheduleHtml = data.data.scheduled_shows.map(show => `
                                <div class="col-lg-4 col-md-6 mb-3">
                                    <div class="card media-card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">${show.series_title}</h6>
                                            <p class="card-text">${show.episode_title}</p>
                                            <div class="row small">
                                                <div class="col-6">
                                                    <strong>Season:</strong> ${show.season}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Episode:</strong> ${show.episode}
                                                </div>
                                                <div class="col-12">
                                                    <strong>Air Date:</strong> ${show.air_date}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                            document.getElementById('scheduleSection').innerHTML = '<div class="row">' + scheduleHtml + '</div>';
                        } else {
                            document.getElementById('scheduleSection').innerHTML = '<div class="text-center text-muted"><i class="bi bi-calendar-event display-1"></i><p class="mt-2">No scheduled shows for the selected time period</p></div>';
                        }

                        // Update timestamps
                        document.getElementById('moviesLastUpdated').textContent = `Updated: ${formatTimestamp()}`;
                        document.getElementById('tvLastUpdated').textContent = `Updated: ${formatTimestamp()}`;
                        document.getElementById('scheduleLastUpdated').textContent = `Updated: ${formatTimestamp()}`;
                    } else {
                        // Handle API errors gracefully
                        document.getElementById('moviesSection').innerHTML = '<div class="alert alert-warning">Unable to load movie data. Please check your Plex configuration.</div>';
                        document.getElementById('tvShowsSection').innerHTML = '<div class="alert alert-warning">Unable to load TV show data. Please check your Plex configuration.</div>';
                        document.getElementById('scheduleSection').innerHTML = '<div class="alert alert-warning">Unable to load schedule data. Please check your Sonarr configuration.</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('moviesSection').innerHTML = '<div class="alert alert-danger">Error loading content data</div>';
                    document.getElementById('tvShowsSection').innerHTML = '<div class="alert alert-danger">Error loading content data</div>';
                    document.getElementById('scheduleSection').innerHTML = '<div class="alert alert-danger">Error loading schedule data</div>';
                });
        }
        
        function loadLibraryStatsPromise() {
            if (!document.getElementById('showLibraryStats').checked) return Promise.resolve();
            
            return fetch('/api/library_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.library_stats) {
                        const stats = data.library_stats;
                        const statsHtml = `
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="card bg-primary text-white h-100">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">${stats.total_movies}</h3>
                                            <p class="card-text">Total Movies</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card bg-success text-white h-100">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">${stats.total_shows}</h3>
                                            <p class="card-text">Total TV Shows</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Libraries</h6>
                                            ${stats.libraries.map(lib => `
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span><i class="bi bi-folder me-2"></i>${lib.title}</span>
                                                    <span class="badge bg-secondary">${lib.count} items</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('libraryStatsSection').innerHTML = statsHtml;
                        document.getElementById('libraryStatsLastUpdated').textContent = `Updated: ${formatTimestamp()}`;
                    } else {
                        document.getElementById('libraryStatsSection').innerHTML = '<div class="alert alert-warning">Unable to load library statistics. Please check your Plex configuration.</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('libraryStatsSection').innerHTML = '<div class="alert alert-warning">Unable to load library statistics. Please check your Plex configuration.</div>';
                });
        }

        function updateSectionVisibility() {
            // Status section
            const statusRow = document.getElementById('statusRow');
            if (statusRow) statusRow.style.display = document.getElementById('showStatus').checked ? 'block' : 'none';
            
            // Movies section  
            const moviesRow = document.getElementById('moviesRow');
            if (moviesRow) moviesRow.style.display = document.getElementById('showMovies').checked ? 'block' : 'none';
            
            // TV Shows section
            const tvRow = document.getElementById('tvShowsRow');
            if (tvRow) tvRow.style.display = document.getElementById('showTVShows').checked ? 'block' : 'none';
            
            // Schedule section
            const scheduleRow = document.getElementById('scheduleRow');
            if (scheduleRow) scheduleRow.style.display = document.getElementById('showSchedule').checked ? 'block' : 'none';
            
            // Library Stats section
            const libraryStatsRow = document.getElementById('libraryStatsRow');
            if (libraryStatsRow) libraryStatsRow.style.display = document.getElementById('showLibraryStats').checked ? 'block' : 'none';
        }

        function loadLibraryStats() {
            if (!document.getElementById('showLibraryStats').checked) return;
            
            fetch('/api/library_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.library_stats) {
                        const stats = data.library_stats;
                        const statsHtml = `
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="card bg-primary text-white h-100">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">${stats.total_movies}</h3>
                                            <p class="card-text">Total Movies</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card bg-success text-white h-100">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">${stats.total_shows}</h3>
                                            <p class="card-text">Total TV Shows</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Libraries</h6>
                                            ${stats.libraries.map(lib => `
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span><i class="bi bi-folder me-2"></i>${lib.title}</span>
                                                    <span class="badge bg-secondary">${lib.count} items</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('libraryStatsSection').innerHTML = statsHtml;
                        document.getElementById('libraryStatsLastUpdated').textContent = `Updated: ${formatTimestamp()}`;
                    } else {
                        document.getElementById('libraryStatsSection').innerHTML = '<div class="alert alert-warning">Unable to load library statistics</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('libraryStatsSection').innerHTML = '<div class="alert alert-danger">Error loading library statistics</div>';
                });
        }

        let autoRefreshInterval;
        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (document.getElementById('autoRefresh').checked) {
                autoRefreshInterval = setInterval(() => {
                    loadStatus();
                    loadRecentContent();
                    loadLibraryStats();
                }, 5 * 60 * 1000);
            }
        }

        // Make functions globally accessible
        window.refreshDashboard = refreshDashboard;
        window.updateSectionVisibility = updateSectionVisibility;

        // Add event listeners for settings changes
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handler for the refresh button
            const refreshBtn = document.querySelector('button[onclick="refreshDashboard()"]');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    refreshDashboard();
                });
            }

            document.getElementById('daysRange').addEventListener('change', refreshDashboard);
            
            ['showStatus', 'showMovies', 'showTVShows', 'showSchedule', 'showLibraryStats'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateSectionVisibility);
                }
            });
            
            const autoRefreshElement = document.getElementById('autoRefresh');
            if (autoRefreshElement) {
                autoRefreshElement.addEventListener('change', setupAutoRefresh);
            }

            // Initial load
            refreshDashboard();
        });
    </script>

    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin {
            animation: spin 1s linear infinite;
        }
    </style>
</body>
</html>